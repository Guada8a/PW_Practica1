<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="/assets/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
        crossorigin="anonymous"></script>
    <title>Personas</title>
</head>
<body>
    <header id="header2">
        <h1>
            <svg role="img" aria-label="Go to the Organization Home" class="leafygreen-ui-l72deg lg-ui-logo-0000" height="32" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 32"><path d="M10.2503 3.56662C8.90729 1.97316 7.75079 0.354795 7.51452 0.0186734C7.48964 -0.00622447 7.45233 -0.00622447 7.42746 0.0186734C7.19118 0.354795 6.03469 1.97316 4.69165 3.56662C-6.83603 18.2688 6.50725 28.1906 6.50725 28.1906L6.61915 28.2653C6.71864 29.7965 6.96735 32 6.96735 32H7.96219C7.96219 32 8.21091 29.809 8.31039 28.2653L8.4223 28.1782C8.43473 28.1906 21.778 18.2688 10.2503 3.56662ZM7.46477 27.9665C7.46477 27.9665 6.86787 27.4561 6.70621 27.1947V27.1698L7.42746 11.1605C7.42746 11.1107 7.50208 11.1107 7.50208 11.1605L8.22333 27.1698V27.1947C8.06167 27.4561 7.46477 27.9665 7.46477 27.9665Z" fill="white"></path></svg>
            MongoDB: <small>Personas</small></h1>
    </header>
    <main>
        <div class="table-responsive">
            <table class="table caption-top">
                <caption>
                    <div class="d-flex flex-row justify-content-between">
                        <div class="d-flex justify-content-start">
                            <h5>Listado de Personas</h5>
                        </div>
                        <div class="d-flex justify-content-center">
                            <input class="form-control form-control-sm" type="search" placeholder="Buscar..." id="buscar" aria-label="default input example">
                        </div>
                        <div class="d-flex justify-content-end">
                            <a class="btn btn-outline-primary btn-sm" href="/gente"><i class="bi bi-arrow-clockwise"></i> Actualizar</a>
                        </div>
                    </div>
                </caption>
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>NSS</th>
                        <th>Nombre</th>
                        <th>Edad</th>
                        <th>Tipo de Sangre </th>
                        <th colspan="2">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <%if (Persons.length == 0) { %>
                    <tr>
                        <td colspan="6" style="text-align: center;">
                            <h5>No hay registros</h5>
                        </td>
                    </tr>
                    <% }else{ 
                        Object.keys(Persons).forEach(function(prop){ %>
                    <tr>
                        <td><b><i><%= parseInt(prop)+1 %></i></b></td>
                        <td><%= Persons[prop].nss %></td>
                        <td><b><%= Persons[prop].nombre %></b></td>
                        <td><%= Persons[prop].edad %></td>
                        <td><%= Persons[prop].tipoSangre %></td>
                        <!-- Envie el array de Personas como un nuevo atributo para manipularlo en la función-->
                        <td><a class="btn btn-outline-danger btn-sm" href="#" data-person="<%= JSON.stringify(Persons[prop]) %>" onclick="borrarModal(event)"><i class="bi bi-trash"></i> Delete</a></td>
                        <td><a class="btn btn-outline-warning btn-sm" href="./findById/<%=Persons[prop]._id%>"><i class="bi bi-pencil-square"></i> Update</a></td>
                    </tr>
                    <% } );
                    }
                    %>
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="7" style="text-align: right;">
                            <h6 class="float-md-start">
                                Ultima actualización: <b><%= new Date().toLocaleString() %></b>
                            </h6>
                            <h5 class="float-md-end">Total de Registros: <b><%= Object.keys(Persons).length %></b></h5>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <footer>
            <a href="./addPerson" class="btn btn-outline-success"><i class="bi bi-plus-circle"></i> Agregar</a>
            <a href="./addRandomPersons" class="btn btn-outline-dark"><i class="bi bi-shuffle"></i> Agregar 10 Randoms</a>
        </footer>
    </main>
    <script type="text/javascript">
        function borrarModal(event) {
            event.preventDefault();

            // Obtener la información de la persona desde el atributo data-person
            const personData = JSON.parse(event.target.getAttribute('data-person'));

            // Obtener los elementos HTML que queremos modificar en la modal
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');

            // Actualizar los elementos HTML con la información de la persona
            modalTitle.textContent = 'Eliminar persona';
            modalBody.innerHTML = `
                <p>¿Está seguro que desea eliminar a la siguiente persona?</p>
                <pre><code>
                    ${JSON.stringify(personData, null, 1)}
                </code></pre>
                <div align="center">
                    <input type="button" data-person="${ personData._id }" onclick="borrarPersona(event)" id="btnEliminar" class="btn btn-danger" value="Eliminar">
                    <input type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" value="Cancelar">
                </div>
            `;

            // Mostrar la modal
            const modal = new bootstrap.Modal(document.getElementById('borrarModal'));
            modal.show();
        }
        function borrarPersona(event){
            event.preventDefault();
            // Obtener la información de la persona desde el atributo data-person
            const personData = event.target.getAttribute('data-person');
            // Abrir modal con spinner de eliminar y confirmación que dure 4 segundos
            const modalBody = document.getElementById('modal-body');

            modalBody.innerHTML = `
                <div class="d-flex justify-content-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h2>Eliminando persona...</h2>
                </div>
            `;
            setTimeout(() => {
                modalBody.innerHTML = `
                    <div class="alert alert-success" role="alert">
                        Persona eliminada correctamente
                    </div>
                `;
                // Enviar el id a la ruta de eliminar
                window.location.href = `./deletePerson/${personData}`;
            }, 50);
        }
        // Guardar referencia a la fila de "No se encontraron resultados"
        let noResultsRow;

        // Función para buscar personas
        document.getElementById('buscar').addEventListener('keyup', buscarPersonas);

        function buscarPersonas(event) {
            // Obtener el valor del input
            const valor = event.target.value.trim();
        
            // Obtener todas las filas de la tabla
            const filas = document.querySelectorAll('tbody tr');
        
            // Si el campo de búsqueda está vacío, mostrar todas las filas y eliminar la fila de "No se encontraron resultados"
            if (valor === '') {
                filas.forEach(fila => {
                    fila.style.display = '';
                });
            
                if (noResultsRow) {
                    noResultsRow.remove();
                    noResultsRow = null;
                }
            
                return;
            }
        
            // Recorrer las filas
            let encontrados = false;
            filas.forEach(fila => {
                // Obtener el contenido de la fila
                const contenido = fila.textContent.toLowerCase();
                // Verificar si el contenido de la fila contiene el valor del input
                if (contenido.includes(valor.toLowerCase())) {
                    // Mostrar la fila
                    fila.style.display = '';
                    encontrados = true;
                } else
                    // Ocultar la fila
                    fila.style.display = 'none';
            });
            
            // Si no se encontraron resultados, crear una fila de "No se encontraron resultados"
            if (!encontrados)
                if (!noResultsRow) {
                    const tbody = document.querySelector('tbody');
                    noResultsRow = document.createElement('tr');
                    const noResultsCell = document.createElement('td');
                    noResultsCell.setAttribute('colspan', '7');
                    noResultsCell.textContent = 'No se encontraron resultados';
                    noResultsRow.appendChild(noResultsCell);
                    tbody.appendChild(noResultsRow);
                }
            else {
                // Si se encontraron resultados y la fila de "No se encontraron resultados" existe, eliminarla
                if (noResultsRow) {
                    noResultsRow.remove();
                    noResultsRow = null;
                }
            }
        }
    </script>
    <!-- Modal -->
    <!--- Esta modal se muestra al momento de eliminar a una persona-->
    <div class="modal" id="borrarModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5><b class="modal-title" id="modal-title"></b></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="modal-body"></div>
            </div>
        </div>
    </div>
</body>
</html>